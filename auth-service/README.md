# Authentication in SDUCloud

TODO: We might want to increase `refreshToken` size

## Introduction

Authentication in SDUCloud is driven primarily by the use of JSON Web Tokens
(JWT). A JWT is cryptographically signed __transparent__ token (i.e. anyone
can read the contents). The token will contain basic information about a
security principal. In SDUCloud this information includes:

- Username
- Primary email
- First and last names
- System wide role (`USER`, `ADMIN`, `SERVICE`)
- Expiration time (usually 5 minutes)

It is important to note that __everyone, including normal users,__ can read
the contents of a JWT. As a result it is important that no sensitive
information is stored in them. All JWTs are signed with a digital signature
by then authentication service. This ensures that all clients (including
services) can verify that a JWT is valid, __without contacting the
authentication service__. The JWTs are signed with the RSA256 algorithm
(public-key cryptography).

In short, a JWT is sufficient proof, for any service, that a user is
authenticated with the system. With a JWT any client will be to act as that
user. As a result, it is important that the JWT is never leaked. To limit the
amount of damage that can occur from a leaked JWT the expiration time is set
to 5 minutes. When a JWT has expired it will be universally rejected by all
services.

When a user successfully authenticates with the authentication service, he is
provided with two tokens:

1. A JSON Web Token (access token) 
2. A refresh token

The refresh token is used for retrieving a fresh JWT. This is how we can away
with having a expiry time of 5 minutes on the JWT.

## Authentication Flow

TODO

## Storage in Web Clients

All web clients must use a special endpoint for refreshing access tokens.
This endpoint expects the refresh token to be stored in a cookie.
Additionally a CSRF token is expected in a special header.

The following tokens are stored in the browser:

- `accessToken` (localStorage): A JWT used for authenticating the actual
request.
- `refreshToken` (cookie, Secure, HttpOnly, SameSite = strict): The token used
for refreshing 
- `csrfToken` (localStorage): A CSRF token. Generated by the auth service.
Is required for refreshing via the web endpoint. It should be placed in the 
`X-CSRFToken` header.

During a refresh both the `refreshToken` and `csrfToken` is required. The
`refreshToken` is, however, the only piece of information to perform the
actual refresh. It is important that the `refreshToken` is stored in such a way
that it is not stolen during an XSS attack (`HttpOnly`).

Given that the `refreshToken` is passed as a cookie to the server, it is
important that we protect against CSRF attacks. This is partially done via
the `SameSite = strict` part of the cookie. However, the `SameSite` attribute
is still not widely supported. To protect against older clients we enforce
that a CSRF token must be added in the `X-CSRFToken` header. It is important
that the CSRF token itself is not capable of refreshing the token (since it
can be leaked via an XSS attack).

The backend server will ensure that the origin/referrer headers match the
expected origin. If neither of these are present the request is blocked. Then
the CSRF token is compared against the token stored server side (along with
the refresh token). On a successful refresh the CSRF token is renewed and
sent alongside the access token.