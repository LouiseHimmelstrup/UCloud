# Synchronization Mounter

The sync-mounter service is responsible for mounting and unmounting
folders to a volume shared with the Syncthing container.

The sync-mounter service is meant to be run in a container separate from
the rest of the backend, on the same pod as the Syncthing container.
Communication happens between the Storage service and the Sync Mounter service.

The primary goals of the Sync Mounter service is to:

 1. Prevent symbolic links from being added to Synchronization,
 2. Keep Syncthing from having direct access to storage.

## Initialization
When Sync Mounter is started, it will fetch a list of folders which needs to be synchronized on
the device, from the storage service. It will then call `mount` with the list as an argument.

Afterwards a Sync Mounter marks itself as `ready` (see `ready` call).

## Calls
### `mount`
`mount` takes a list of UUIDs (generated by the storage service) and corresponding
source paths. After validating a source path, `unmount` is called, which will unmount and delete
the corresponding folder if any.

A file descriptor is obtained for each sub-path in the source path, using the `openat` file system call,
with the `NOFOLLOW` flag on. If any sub-path is a symbolic link, `openat` fails, and `mount` throws an exception.

Otherwise we obtain the file descriptor for the full source path, and bind-mount it to
a volume accessible by Syncthing, using the corresponding UUID as the target path.


### `unmount`
`unmount` takes a list of UUIDs each corresponding to a synchronized folder.
Since mounted folders are saved by their UUID, `unmount` generates the target
path for each UUID, validates this path and check if it exists.

Afterwards the `umount` file system call is used to unmount the folder, and finally
the folder is deleted.

### `ready`
Returns true if Sync Mounter is initialized, that is, all folders have been mounted, false otherwise.
