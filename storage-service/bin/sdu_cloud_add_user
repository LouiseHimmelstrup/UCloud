#!/usr/bin/env bash
set -e

USER=$1
PRETTY=$2

#useradd -d / -s /bin/false "${USER}" # Compatible with CentOS
adduser -D -H -s /bin/false "${USER}" # Compatible with Alpine (busybox)

if [ ! -f /mnt/cephfs/home ]; then
    mkdir -p /mnt/cephfs/home
    chown 711 /mnt/cephfs/home
fi

# User initialization
mkdir -m771 "/mnt/cephfs/home/${PRETTY}/"
mkdir -m771 "/mnt/cephfs/home/${PRETTY}/Favorites"
mkdir -m771 "/mnt/cephfs/home/${PRETTY}/Jobs"
mkdir -m771 "/mnt/cephfs/home/${PRETTY}/Uploads"
mkdir -m771 "/mnt/cephfs/home/${PRETTY}/Trash"

# For some reason busybox is having problems chowning directly on the username
# TODO That will likely become a problem later
chown -R `id -u ${USER}`: "/mnt/cephfs/home/${PRETTY}"
