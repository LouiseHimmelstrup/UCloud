# https://sequencediagram.org/

autoactivation
actor "UCloud User\nAlice#1234" as User

participantgroup #lightgreen ** UCloud\nNetwork**
participant "UCloud" as UCloud
database "UCloud DB" as UCloudDB
end

participantgroup #lightblue **Provider\nNetwork**
participantgroup #lightyellow **New components**
participant "Integration Module" as Provider
database "Integration DB" as UserDB
end
participantgroup #pink **Existing components**
participant "                                 HPC                                 " as HPC
end
end

opt Can be skipped if explcit user initialization isn't required
User->UCloud: Connect with provider
UCloud->Provider: Alice#1234 wishes to connect
Provider->HPC: Initialize user\nAlice#1234
HPC->HPC: Initialize storage
HPC-->HPC: OK
HPC->HPC: Additional config
HPC-->HPC: OK
HPC-->Provider: OK
Provider->UserDB: Alice#1234 has connected
UserDB-->Provider: OK
Provider-->UCloud: Mapping for Alice#1234 complete
UCloud->UCloudDB: Save mapping
UCloudDB-->UCloud: OK
UCloud-->User: Success
end

== Alice#1234 can now consume resources from the provider ==

User->UCloud: Start job
UCloud->UCloudDB: Is mapping \ncomplete?
UCloudDB-->UCloud: Yes
UCloud->Provider: Start job for Alice#1234\nauthenticated with _UCloud\naccessToken
note right of Provider: UCloud verifies the integration\nmodule using TLS
Provider->Provider: Verify accessToken\nof _UCloud
Provider-->Provider: OK

note over Provider: Actions are at this point\nguaranteed to be sandboxed\nto a single non-root user

Provider->Provider: Is Alice#1234 allowed to\nperform this action?
Provider-->Provider: Yes
Provider->HPC: Start job
HPC-->Provider: OK
Provider-->UCloud: OK
UCloud-->User: OK