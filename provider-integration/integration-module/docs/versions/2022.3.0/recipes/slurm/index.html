<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Slurm + distributed file system - UCloud/IM Documentation</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <section>
        <h1>Recipes / Slurm + Distributed file system</h1>
        <h2 class="summary">A traditional HPC system consisting of Slurm and a distributed POSIX file system.</h2>
    </section>

    <article>
        <h2 id="prerequisites">Prerequisites</h2>
        <p>The UCloud Integration Module should be deployed on the HPC frontend or a node with a similar configuration.
            In
            particular, the following requirements must be satisfied.</p>
        <ul>
            <li>The machine must be able to communicate with Slurm using the normal Slurm CLI commands.</li>
            <li>The machine must have access to the distributed storage system and the filesystem(s) must be accessible
                via
                the same path(s) as the compute nodes.</li>
            <li>The machine must use the same user database as the compute nodes, such that users and ids are consistent
                across the entire cluster.</li>
        </ul>
        <p>For security reasons, the integration module should always run as a non-privileged user. In the following we
            assume the user is called <code>ucloud</code> with a dedicated primary group also called
            <code>ucloud</code>.
            This user will need to be granted a couple of extra privileges, as described in the following sections.
        </p>
        <p>The following directories are used by the integration module by default. Some of these paths can be changed
            if
            needed, but make sure to consistently change them in all configuration files.</p>

        <doc-table>
            <table>
                <thead>
                    <tr>
                        <th>Path</th>
                        <th>Permissions</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/opt/ucloud</code></td>
                        <td><code>0755 (ucloud:ucloud)</code></td>
                        <td>Installation path for the integration module</td>
                    </tr>
                    <tr>
                        <td><code>/opt/ucloud/extensions</code></td>
                        <td><code>0755 (ucloud:ucloud)</code></td>
                        <td>Installation path for custom extension scripts used by the integration module</td>
                    </tr>
                    <tr>
                        <td><code>/etc/ucloud</code></td>
                        <td><code>0755 (ucloud:ucloud)</code></td>
                        <td>Configuration files for the integration module</td>
                    </tr>
                    <tr>
                        <td><code>/var/run/ucloud</code></td>
                        <td><code>0755 (ucloud:ucloud)</code></td>
                        <td>Run-time data for the integration module (see systemd file)</td>
                    </tr>
                    <tr>
                        <td><code>/var/log/ucloud</code></td>
                        <td><code>0733 (ucloud:ucloud)</code></td>
                        <td>Log files for the integration module (see systemd file)</td>
                    </tr>
                </tbody>
            </table>
        </doc-table>

        <h3 id="sudo">Sudo</h3>
        <p>
            Because the integration module acts on behalf of the HPC users, it must be allowed to spawn an instance of
            itself as that user. By spawning an instance of itself as the user in question, we are guaranteed that the
            integration module has exactly the same permissions, as if the user had accessed the system via e.g. SSH.
        </p>
        <p>
            The easiest way to grant this permission is by creating a file <code>/etc/sudoers.d/ucloud</code> with the
            following content.
        </p>

        <doc-snippet>
            ucloud ALL=(%ucloud_users) NOPASSWD: /opt/ucloud/ucloud /opt/ucloud/extensions/*
        </doc-snippet>

        <p>This allows the <code>ucloud</code> user to run the integration module itself <code>/opt/ucloud/ucloud</code>
            and
            all extension scripts, as any user in the group <code>ucloud_users</code>. By restricting ourselves to a
            specific group of users, we can ensure that the integration module is never spawned as a non-HPC user.</p>
        <h3 id="slurm">Slurm</h3>
        <p>Making the <code>ucloud</code> user an administrator in Slurm is often necessary, but ultimately it depends
            on
            the local environment. Some of the extension scripts will run as the <code>ucloud</code> user, so if any of
            these need to modify Slurm accounts or users, then administrator privileges are needed.</p>
        <p>Use the following commands to create the <code>ucloud</code> user in Slurm and grant it administrator
            privileges.
        </p>

        <doc-snippet>
            sacctmgr -i create user ucloud account=root
            sacctmgr -i modify user ucloud set adminlevel=admin
        </doc-snippet>

        <h3 id="system-service">System service</h3>
        <p>To start and stop the integration module we suggest to use a systemd service. Create the file
            <code>/usr/lib/systemd/system/ucloud-im.service</code> with the following content.
        </p>

        <doc-snippet>
            [Unit]
            Description=UCloud Integration Module
            After=network-online.target

            [Service]
            Type=simple
            User=ucloud
            Group=ucloud
            Restart=on-failure
            RestartSec=5s
            ExecStartPre=/bin/install -d -m 755 -o ucloud -g ucloud /var/run/ucloud
            ExecStartPre=/bin/install -d -m 755 -o ucloud -g ucloud /var/run/ucloud/envoy
            ExecStartPre=/bin/install -d -m 733 -o ucloud -g ucloud /var/log/ucloud
            ExecStart=/opt/ucloud/ucloud

            [Install]
            WantedBy=multi-user.target
        </doc-snippet>

        <p>This service file will start the integration module as the <code>ucloud</code> user and before starting it
            will
            create a couple of directories with the proper permissions. Moreover, the service will automatically restart
            in
            case of failures. To start and enable the service, use:</p>

        <doc-snippet>
            systemctl enable --now ucloud-im.service
        </doc-snippet>
    </article>
    <script src="/app.js"></script>
</body>
</html>
